摘  要	
近些年来，电子游戏作为人类娱乐的主要方式，正在蓬勃发展，其中网络游戏又占据主流。当越来越多的玩家涌入网络游戏市场，尤其是当移动网络游戏作为增长点时，玩家所处的复杂网络环境和“开机即用”的使用要求，给游戏服务器开发带来了极大挑战。游戏更新需要停机、线上生产环境故障需要回滚、老框架无法容纳新需求等开发难题急需解决。
与此同时，在其他服务器开发领域，逐渐出现了许多基于微服务开发的优秀开源项目。微服务由多个自我闭合、实现功能的应用组成，每个应用在逻辑上完成功能，并部署在不同的容器上，通过容器技术的隔离性完成与其他模块的隔离，与操作系统的隔离，与物理机器的隔离[2]。当微服务搭配上云原生技术一起使用时，起到了1+1远大于2的效果，在开发效率和运维成本上有着无与伦比的优势[3]。
为了解决在游戏服务器开发中的性能问题和拓展性问题，本文将按照微服务设计理念重新设计游戏服务器架构。主要内容如下：1）分析现有游戏服务器项目架构存在的问题，按照微服务的12要素对游戏服务器架构。2）遵循“新功能使用微服务形式、拆分单体应用重构为微服务形式”两大原则，在原有游戏服务器项目上，将各功能模块解耦，实现微服务化。3）使用docker选择性地将微服务实例部署所需的开发环境容器化后，将各个微服务实例部署到由Kubernetes管理的云服务器上，实现编码—构建—部署三步走的自动化，提升开发效率。4）编写客户端模拟器对游戏服务器进行测试，测试结果表明新架构的性能有较大的提升，由Kubernetes管理的微服务能够实现不停机更新、快速回滚、快速发布等功能，在代码目录结构上重新划分了功能区间，更便于开发。
	主题词	主题词数量不多于三个，主题词之间空一格（英文用“/ ”分隔）
		中文	微服务、游戏服务器、云服务
		英文	Microservices/Game Server/Cloud Service







二、选题依据
1．	阐述选题背景，研究意义，或工程设计的价值和意义，该选题国内外技术应用现状和发展趋势，选题的先进性和实用性。
1.1	选题的研究意义
游戏作为人类的一种主要休闲娱乐方式，从古至今伴随着人类社会的发展与变迁，其具体表现形式也越来越多。根据Newzoo发布的《2021全球游戏市场报告》，2021年全世界电子游戏市场份额在一年还未结束时已超万亿人民币。此外，在疫情肆虐、仍需长期抗疫的背景下，电子游戏市场仍能保持稳定增速和拥有巨大潜力，电子游戏玩家90%为移动玩家为上述条件提供了强有力证明。
日益增长的游戏需求同落后的游戏服务器性能产生了巨大矛盾。玩家在一局游戏中，但凡有一次卡顿或者掉线的情况都会极大地影响游戏体验，超过一次甚至会让黏性不高的玩家直接放弃游戏，所以不但要保证游戏交互时延足够低，还要保证游戏交互时延一直保持在较低的、稳定的水平[4]。在以上三个苛刻的标准：低时延、多对局、稳定性下[5]，如何通过优化架构来提升游戏服务器性能急需解决。
在传统游戏服务器开发中被广泛应用的单体代码架构，将所有功能集成在一个应用中，各个功能模块之间主要通过共享内存的方式通信，访问速度很快，前期开发速度也很快。但随着需求迭代更新，单体应用变得越来越臃肿，各功能模块的界限变得越来越模糊，开发时新增一个简单的功能需要改动数个地方。而且单体应用体积越大的话，想要运行起来所需要的机器性能也越高，在调试时难以定位问题等等开发矛盾也逐渐浮出水面。将以上问题带入三个标准的话，庞大的单体应用在运行时需要占用大量资源，难以实现多对局；其中一部分引起的崩溃问题会带动整个应用崩溃，稳定性低下；似乎只有基于共享内存实现的通信维持了低时延的性质，但越来越多的代码对共享内存频繁加锁引起的并发问题导致低时延也不一定能实现。
    以上问题并不只是在游戏服务器开发领域出现，甚至在其他开发方向早早遇到了该问题，并产出了许多破解之道。其中微服务作为最后的胜利者，成为了大多数开发者的选择。微服务是指内部逻辑闭环的单个独立应用，对外提供服务。微服务强调独立性，即不需要依赖其
他环境就能运行，也强调专业性，即每项服务只提供一种功能。这种设计理念将应用拆分，想要拓展已有的微服务只需要新增微服务实例，具有很强的横向扩展性；想要添加新功能，只需要将新功能作为新的微服务加入已有的微服务中。在微服务的实际应用中，通常将一个微服务放到一个容器中运行，借助容器的资源隔离性能够实现微服务的隔离性，单个微服务的崩溃不会引起其他微服务的崩溃，具有稳定性。使用Kubernetes容器编排平台对容器进行合理调度，实现代码版本的快速回滚和快速部署，极大地提升了开发效率。相对于单体代码架构，使用微服务架构进行开发，有以下优点：1）能有效地分工，专人负责一个微服务，通过敏捷开发快速迭代新版本，缩短了开发周期；2）游戏服务器更新不需要暂停服务，客户端无感知或轻感知；3）运维管理自动化；4）减少对物理机资源的浪费，降低成本。
本文通过微服务，一种历经时间考验、被越来越多人所接受并应用到实际开发中的软件工程开发理念，有效地把游戏服务器功能拆解为大小适中、性能良好和耦合性低的微服务模
块，来应对移动游戏服务器日益增长的性能需求和开发速度需求。
1.2国内外概况和发展趋势
电子游戏作为计算机上的一种应用程序，随着计算机地诞生而诞生，随着计算机地流行而流行。而且需要用到游戏服务器这项技术的，更是只有网络游戏——电子游戏的一个分支。并且网络游戏对计算机网络、计算机性能、游戏应用程序设计等方面有极高的标准，达不到这些标准是无法提供良好的网络游戏环境的。所以随着近些年来因特网上的网络质量提升、计算机性能提升、大批从业人员涌入游戏开发领域等因素的作用下，游戏服务器的开发才逐渐变为可能。游戏服务器以其他服务器的开发经验为基础，对如何做才能提供网络游戏基础服务这方面进行了特别优化。
长期以来，因为计算机起源于英语系国家，所以英语系国家在计算机领域和软件开发领域一直有着领先优势。但正如前面提到的，游戏服务器开发所需的计算机基础并未在计算机诞生之时就达标，直到20世纪90年代才有堪堪可玩的网络游戏发行。此时国内也开始引进计算机并积极地吸取国外优秀经验。同时国内也有后发优势，不用再摸着石头过河，而是踩着石头过河。舍弃国外游戏服务器开发经验中的糟粕，将广泛应用的技术和设计理念进行本
地化改造，就是国内游戏服务器开发的现状。直到今天为止，国内在游戏服务器开发方面可以说是反超国外，主要归功于国内游戏市场的蓬勃发展催生出了多种多样的游戏服务器需求，以及将软件工程开发的理念与实践经验带入游戏服务器开发，在这双重催化剂的作用下多点开发，出现了大量专注于网络游戏开发的公司。
2008年Netflix公司的数据中心遇到了故障，导致DVD租赁服务故障3天，造成了大量损失。在事后反思环节，该公司技术人员发现现有服务器架构在遇到单点故障时会引起整个服务的崩溃，从而决定转向使用微服务重新设计架构。之后该公司开源自己使用的微服务框架之后，该框架便作为微服务在大型生产环境下应用的最好例子。除此之外，还有很多微服务框架，例如：SpringCloud、Dubbo等。现如今很多公司所使用的微服务框架或多或少都有参考以上被广泛认可的开源框架设计。
2018年腾讯北极光工作室推出的《天涯明月刀手游》，主要是将天涯明月刀端游玩法移植到移动设备上，在服务器选型方面，着力解决端游服务器架构的痛点，使用微服务架构进行开发，相较于端游服务器在性能上、成本上和开发效率上都有极大提升。
从通信架构来看，游戏服务器主要分为两种架构，一种是经典且占据主要市场的Client/Server架构，一种是不太多见的P2P架构[5]。P2P架构会因为单个玩家的网络质量而影响所有玩家的游戏体验，并且由于该种架构会在每两个玩家间都创建连接，难以支持很多人同时在线的游戏，所以现在基本是C/S架构。
从编程语言来看，由于游戏服务器对于性能的要求很高，在没办法提高硬件性能的情况下，21世纪初开发的很多网络游戏都使用了C++开发服务器来提供软件性能，并且这个习惯传承到了今天，所以依然有很多游戏服务器仍在使用C++。但随着其他语言的迭代更新和计算机硬件性能的提升，开发效率和后期维护成本作为评价指标的优先级提高了很多，不再以性能论。
从工程设计的角度来看，在游戏服务器开发兴盛时，软件工程已经成为了一门从实践中
诞生，并系统地描述编程开发中应遵从什么样步骤进行开发的科学。所以国外工程师将软件工程付诸实践，带入到了实际开发中，主要体现在先分析需求、再设计、再编码上。而国内由于有庞大且活跃的市场需求，不要求有很高的交付质量，但要求有很快的交付速度，所以在实际开发中会省略不少软件工程应有的步骤。近年来这种堆人力堆时间而不考虑质量的方法产出价值越来越少，很多公司开始回头审视因不合理要求而产生的代价到底有多大，从而逐渐走上了系统化使用软件工程思想作为开发方向的道路。
1.3选题的先进性和实用性
微服务这个概念是2011年才被提出，最近几年才被大量应用到商业系统中的。通过拆分服务、解耦服务，将庞大且臃肿的单个系统变为精致且小巧的多个微服务，这种理念天生适配如今人人都在谈的分布式、云计算等概念，具有一定的先进性。
将微服务带入到游戏服务器的设计中能够有效降低前期开发难度、中期测试难度和后期运维成本[5]，同时对外能不改变逻辑使用方法并提供更优质的服务体验，具有一定的实用性。
1.4选题的技术难度和工作量
现有的游戏服务器功能复杂且繁多，各个模块之间耦合性高，且由多人共同开发完成，各个编程习惯、编程规范并未统一，拆分模块难度高；解耦后各模块组成系统的性能、开发效率和运维成本应当优于老系统，否则没有意义；新系统也应该以云原生的理念为指导，充分发挥现在微服务架构的特性，在云服务器上以最佳姿态运行。综上所述，该选题的技术难度较大，工作量足够。




2.  主要参考文献（列出作者、论文名称、期刊名称、出版年月）
[1]谢景宇. 高并发大型手机游戏服务器的设计与实现[D].东南大学,2019.DOI:10.27014/d.cnki.gdnau.2019.003358.
[2]Bernstein, D. (2014). Containers and cloud: From lxc to docker to kubernetes. IEEE Cloud Computing, 1(3), 81-84.
[3]刘研. 电子游戏的情感传播研究[D].浙江大学,2014.
[4]云淼. 实时网络游戏中关键技术的研究[D].北京工业大学,2015.
[5]Cronin, E., Filstrup, B., & Kurc, A. (2001). A distributed multiplayer game server system. In University of Michigan.
[6]Dragoni N. et al. (2017) Microservices: Yesterday, Today, and Tomorrow. In: Mazzara M., Meyer B. (eds) Present and Ulterior Software Engineering. Springer, Cham. https://doi.org/10.1007/978-3-319-67425-4_12
[7]Newman, S. (2021). Building microservices. " O'Reilly Media, Inc.".
[8]J. Thönes, "Microservices," in IEEE Software, vol. 32, no. 1, pp. 116-116, Jan.-Feb. 2015, doi: 10.1109/MS.2015.11.
[9]Burns, B., Grant, B., Oppenheimer, D., Brewer, E., & Wilkes, J. (2016). Borg, omega, and kubernetes. Communications of the ACM, 59(5), 50-57.
[10]Cormen, T. H., Leiserson, C. E., Rivest, R. L., & Stein, C. (2009). Introduction to algorithms. MIT press.
[11]龚森. 基于微服务架构的电商平台设计与实现[D].北京交通大学,2021.
[12]王曦. 基于Docker的云数据库服务设计与实现[D].电子科技大学,2021.DOI:10.27005/d.cnki.gdzku.2021.002772.
[13]王仪. 基于Kubernetes的容器云平台资源调度策略研究[D].西安理工大学,2021.DOI:10.27398/d.cnki.gxalu.2021.000539.
[14]Carl Boettiger. 2015. An introduction to Docker for reproducible research. SIGOPS Oper. Syst. Rev. 49, 1 (January 2015), 71–79. DOI:https://doi.org/10.1145/2723872.2723882
[15]Fowler, M. (2004). UML distilled: a brief guide to the standard object modeling language. Addison-Wesley Professional.
 
三、课题内容及具体方案
1．课题内容
    根据现有游戏服务器的功能，将其在逻辑上拆分为多个互相通信但不互相耦合的模块。在原功能不变的情况下，实现代码编写。
课题主要分为以下四个部分：
(1)	调查、研究微服务框架的优点，参考其诞生的历史背景和适用的环境来制定本次游戏服务器开发的方向。
(2)	以数据流向为指导，梳理现有系统内部逻辑流，深入理解当前情况下游戏服务器应该具有什么功能以及调用该功能时应该有的速度，合理地划分出各模块的功能区间。
(3)	参考现有服务器设计，完成游戏大厅相关功能、匹配功能、房间功能和对局功能，打通真正游玩的整 个流程。
(4)	完成客户端模拟器，使用该模拟器对服务器现有服务和新加服务进行测试。处理发现的逻辑问题， 优化微服务内部和外部的性能问题和稳定性问题。
(5)	将整个游戏服务器部署在由Kubernetes管理的云服务器集群上，实现运维管理的自动化。
2．	系统需求分析（应用软件工程专业描述工具描述）
2.1 概述
    作为一款多人实时在线对战游戏，从一个玩家的角度来看，玩家希望地是随时随地都能登录游戏并在稳定可靠的服务下体验游戏内容。这种情况下，服务器要为峰值可达10万人同时在线的情况提供稳定可靠的服务，需要仔细分析每一个模块承载的压力并进行合理优化。
2.2 功能需求
如图2.1所示，玩家下载好游戏准备登录的时候，需要给玩家提供一整套鉴权系统，在保护好玩家个人信息的情况下，尽量做到注册和登录的步骤最简化，给玩家最流畅的体验。本游戏是基于腾讯QQ平台运营的，核心卖点是社交互动。进入游戏大厅后，需要提供给玩家诸如邀请好友加入队伍、一键发送邀请到QQ、和好友一起匹配游戏等社交功能，充分把玩家参与社交的意愿调动出来。同时也要考虑到玩家单人游玩的情况，鼓励单人游玩的玩家发现好友、新加好友，形成社交关系链的闭环。
本游戏在服务器方面的需求可以分为以下模块：鉴权模块（登录、注册）、大厅模块、好友模块、战模块、背包模块，如图2.2所示。
 
图2-1 用例图
 
图2-2 模块示例图
2.3性能需求分析
是否要将老旧的技术栈替换为较新的技术栈，主要考虑收益是否大于成本。将原有系统微服务化后，应当在开发效率、系统性能、系统稳定性等方面有提升，并且这些提升带来的收益应该高于微服务化的成本（重构代码、系统线上环境迁移等）。此外，在对微服务进行性能需求分析时，需要考虑到微服务应用相对于单体应用的特殊性：微服务应用既有一个统一的入口——负载均衡器，每个微服务实例也开放了端口作为实例本身的入口。而且微服务将会运行在由kubernetes管理的容器编排平台中，微服务实例所在的容器与底层操作系统隔离，容器的资源分配粒度也不再是传统单体应用的占用单个物理机全部cpu和内存，分配给每个容器的资源多少同样是变化的。基于上述不同，本文的性能需求分析如下：
（1）平台：kubernetes容器编排平台
（2）操作系统：Linux
（3）系统输入：客户端发起的rpc请求
（4）系统输出：返回给客户端的rpc响应
（5）每个容器的cpu和内存占用都保持在60%左右，峰值不超过80%
（6）事务（一次完整的，由客户端发起rpc请求，最终由客户端收到rpc响应的过程）平均耗时在500ms内，95%的事务耗时低于超时时间的50%
2.4 可行性分析
游戏服务器方向的开发长期受限于较短的游戏开发排期，在技术选择上比较保守，更愿意使用以前用过的框架，认为即使出问题也能解决问题或者绕过问题。这样做堆积了不少历史遗留问题，无论是核心代码还是业务代码都难以维护，极大降低了开发效率。此外服务器部分作为整个游戏的中枢，在开发职责上，服务器开发需要和客户端开发、策划、运营和数据分析等多个职能岗位沟通和配合，在原有系统上实现新功能。这种修修补补的工作难以长期高效地完成，急需整合现有资源，在顶层实现逻辑功能的抽象化，增加可复用性，为服务器开发注入新活力。
所以使用微服务解构现有的游戏服务器，将其拆分为多个在逻辑上地位相等但实际功能不同的模块，是可行的。拆分后，各服务内部的逻辑流运动方向和拆分前保持一致，所实现的功能也保持一致，甚至会因为采用微服务架构，在不可避免重构代码时发现原有漏洞并在修复漏洞后带来性能提升和安全性保障。同时也因为架构升级引入新的组件或升级老版本组件，合理利用新的功能特性能让开发变得更高效和系统运行得更流畅。
微服务框架可以兼容原有系统。实际改造中，把原有系统直接作为一个服务，把新需求转化为新服务，实现新老服务的共存，同时对原有系统的功能进行拆解，逐步把拆解出的功能抽象为新服务融入到现有微服务框架中。
本工程最终是由Kubernetes管理，运行在docker容器之上的云服务器集群构成的。基于微服务实现的系统天然适配现在设计成熟的云原生架构，两者都有服务这个概念，两者的服务之间都满足互相隔离、互相提供服务等定义。
综上所述，该选题依靠现有的案例参考，具有较高的可行性。









3．	系统概要设计（应用软件工程专业描述工具描述）
3.1 系统总体设计
 
图3-1 系统架构图
系统架构图如图3-1所示，是非常经典的Client/Server架构。用户使用移动设备登录游戏后，由负载均衡器进行流量均衡，分发到集群中的各个节点。虽然整体系统架构看起来简单，主要是因为将复杂度都集中到k8s集群中，实现了外部用户无感知的服务器架构切换。k8s集群内部主要分为两种类型的节点：控制器节点和普通节点，也对应分布式架构里的Master节点和Slave节点，这两种节点地位相等，区别主要是是否运行了控制器组件。k8s定义并实现了整套API来控制集群，理论上任意节点都可以通过访问API来使用控制器功能，但为了限制滥用，规定上只能由Master节点来使用，如果Master节点宕机或者无法提供服务，会重新选出节点来担任控制器的角色。如图3-2所示，外部用户想要访问k8s内部的服务时，需要经过控制器进行路由寻址，合理地进行负载均衡。同时每个节点内部的proxy进行流量分发，决定由哪个pod来提供该次服务。
如图3-3所示，在k8s集群中，逻辑层和物理层的映射关系不是简单的一对一或者复杂的多对多，在不同层次上有不同的关系。借由Docker容器能够跨平台运行的特点，k8s能够运行基于各种操作系统构建的容器，从而实现了调度跨平台服务的特性。同时采用这样一种抽象概念：一组pod，一种访问它们的策略—也就是  service，也对应微服务中的服务这个概念，将云原生开发和微服务结合了起来。一个服务由一组pod构成，这些pod可以来自同一个node也可以来自不同的node；一个pod由一个或多个容器组成。这种层次分明的映射关系给k8s后续开发带来了极大便利，同时也是实现很多k8s很多特性的关键所在。
 
图3-2 k8s内部架构图
 
图3-3 逻辑层-物理层映射图
3.2 系统模块设计
3.2.1 大厅模块
当玩家进入游戏开始游玩的时候，首先看到的就是大厅。可以说大厅是整个游戏的功能地基，其他服务都是从大厅进入的。所以在大厅服务的技术构造上，需要十分谨慎， 既需要提供高性能的体验，也需要考虑将来添加新功能的拓展性，不能只关注开发速度而忽略质量。从玩家的角度上来说，大厅只是其他服务的一个载体，本身不提供服务。 但从服务器来看，大厅需要和其他各服务通信、交互，起到一个中枢的作用。
 
图3-4 大厅流程图
考虑到上述要求，如图3-4所示，进入游戏后一直在处在大厅的事件循环中，保证每次循环都是单向的数据流动且最终会回到大厅。这种做既能横向拓展，在不改变原有功能的情况下新增功能，也因为简单的事件循环设计而拥有不随功能增加而降低的运行速度。即保证了体验的同时也维护了可拓展性。
3.2.2 好友模块
    本游戏主打的就是社交互动，所以好友模块是核心。那么为了让社交元素在玩家间以一种丝滑的方式流动时，考虑应该满足以下几点：当玩家登录进入游戏大厅的时候就应该加载了好友数据；一键邀请好友加入房间开始对局；在对局结束后可以向任意参与对局的其他玩家一键发出好友申请等。如图3-5所示，保证在玩家加载完大厅前指定时间内一定加载了好友数据，超时则直接加载大厅，能够进入游戏。此时后台依然会尝试拉取好友数据直到拉取成功。如图3-6所示，从服务器的角度来看，一次请求遵循C/S架构，由客户端发起，交由内部微服务模块处理后返回，同时穿插异步消息加快处理速度。其余几点处理方法类似。
 
图3-5 拉取好友客户端时序图
 
                                   图3-6 拉取好友服务器时序图
3.2.3 对战模块
一款社交游戏在靠关系链吸引玩家进入游戏后，留下玩家的要点就是游戏性。同好友模块一样，在尽量保证从大厅到进入对局这个单项流程流畅度的情况下，维持横向可拓展性增加游戏的新鲜感。如图3-7所示，玩家必须要做只有“点击开始游戏”，其余流程则由不同模块的组合构成，保证了流畅度和拓展性。如图3-8所示，流程图中的组队和创建房间，由不同的模块组成。例如在组队流程中，玩家可以执行任意次横向模块，直到真正点击开始游戏后才会进入下一流程。
 
图3-7 进入对局流程图
 
图3-8 组队、创建房间横向拓展图
创建房间时选择了地图和模式，在进入房间后也可以修改。但每个地图会因为大小、道具、障碍、胜利条件等情况有不同的模式。同时也要考虑到后期开放地图创意工坊后，每个模式对应的规则如何交由创作者自由组合。模式是由多个维度的规则复合而成，考虑到未来的新地图和新玩法，动态增删一个模式所拥有的规则是很有必要的。如图3-9所示，通过纵向选择维度种类，横向选择维度数值的方法，既保证了扩展性和自由度，也降低了配置难度。
当玩家进入房间选择了地图和模式之后，下一步就是开始匹配准备进入对战了。匹配算法的选择很大程度上影响玩家的游戏体验，同时作为一款休闲游戏，将弱化竞技对抗的元素，不需要以非常细的粒度区分玩家水平。但考虑到以后可能引入的排名系统，匹配算法应该提供多种选择并做到无感切换。基于以上条件，匹配算法主要使用了贪心算法和动态规划，分别在对竞技对抗要求较高和较低的情况下来使用。多个玩家组成队伍进入房间，房间的房主点击开始游戏后，会根据房间所选择的地图和模式将队伍加入匹配队列，使用匹配算法选择出合适的队伍。在多人在线对战游戏里，合理的匹配机制是非常重要的，应该尽量把水平相近的玩家放入一个对局里。
 
图3-9 模式维度图
贪心算法时间复杂度是O(n)，空间复杂度是O(1)。把"该房间的人数加入该对局后，能最快开始对局"作为贪心选择性质，则贪心算法也可以作为一种匹配算法。贪心算法拥有较快的速度，适用于在线游玩人数较多时使用，能显著降低玩家匹配等待时间。 
动态规划算法时间复杂度是O(n2)，相对贪心算法来说耗费了更多的时间，但得出全局最优解，适合在线游玩人数较少或者将来引入排名系统后的高分段匹配使用。 

定义dp[i][j]为第i只队伍能否加入要求j人的对局， 匹配所使用的状态转移方程是：
 
在进入对局后，游戏服务器方面并不实现游戏的画面和具体逻辑。这些交给服务器来做的话无疑是巨大的负担，也只能将服务器渲染好的画面发送会客户端，这对客户端的网络情况和玩家的流量消耗同样也是不可接受的代价。所以交由客户端来渲染游戏画面。客户端还能做到更多吗？对于玩家来说，在对战的时候希望自己的操作能马上反馈到游戏中，也希望同对局中其他玩家的操作也马上反馈到自己的设备上。这其实是个多玩家同步问题—如何在各玩家网络条件不同的情况下让各玩家操作同步。这个问题显然不是客户端能单独完成的。
为了克服这些问题，需要重新划分模块范围，决定这些功能到底该由服务器实现、客户端实现还是服务器和客户端各实现一部分。
如果将对战想让一场对局中各玩家的操作时延尽可能低，毫无疑问应该使用一块内存存储一场对局中的所有玩家数据，不同对局的所有玩家数据存储在不同的内存中。这种做既有隔离性保证各对局互不影响，也最大限度完成了低时延交互的目标。但客户端显然没办法获得这些数据，所以只能交由服务器来做。综合考虑后，本文采用的是目前业界的普遍做法：由客户端使用游戏引擎实现Dedicated Server（下文简称DS），然后交由服务器端进行管理。DS是由引擎提供专门进行同步的特殊服务器，在网络协议上进行了优化，使得DS与客户端的通信速度非常快。将DS放在服务器部分运行，使得一场对局的网络拓扑结构变为星型，能让任意两个终端通信时延稳定且保持较低数值，同时隔离各个用户，避免外挂引起的安全问题。
如图3-10所示，客户端向服务器发起对战请求后，由服务器的对战服务进行匹配，匹配完成后申请DS并返回DS，之后客户端直接和DS通信，减少中间步骤，降低时延。同时采用池化技术，最大程度复用DS，避免频繁创建或销毁Pod带来的开销。
 
图3-10 DS池示例图
3.2.4背包模块
狭义上，背包是用来存储道具的；广义上，只要是存在时间限制和能够使用的物品都能交由背包模块管理。本系统参考了业界成熟的解决方案，考虑到背包中的物品可能会有堆叠情况，将背包格子和物品分开，交由更高级的抽象类BagMgr进行管理。
 
图3-11背包类图
4．	拟采用的开发方法、环境，测试方案等
4.1拟采用的开发方法
本系统在原有服务器系统的支撑下进行二次开发，将原有系统各个功能逐步剥离并独立出去，实现系统的微服务化。使用微服务理念再开发的过程中，每个服务内部的逻辑流由java编程语言编写，服务之间的通信使用rpc框架， 主要分为以下部分：
(1)合理解耦服务，先基于微服务框架对单个服务进行开发，并同时准备测试用例进行单元测试 。
(2)改造原有内部接口，打通单个服务与原有系统的通信，测试能否替换内部服务正常实现功能。 
(3)重复以上两个步骤直到将原有系统微服务化。
4.2开发环境
操作系统	Linux
编程语言	Java（jdk1.8）
开发工具	Intellij IDEA
数据库	Tcaplus
Rpc框架	基于Tbuspp开发
云原生平台	腾讯蓝盾平台
4.3测试方案
4.3.1 非功能性测试
服务器作为C/S架构中的一端，没有客户端来收发消息的话，很多服务器的功能是无法测试的。但实际开发中，服务器端经常超前开发，很难等到客户端完善后再来开发。在Web服务器开发中，基于主要使用http协议的通信方式，常用模拟构造测试用的 http协议来测试。在java的Spring开发中，经常使用直接注入mock数据的方式来测试。但本系统中并不基于Spring框架开发，且使用注入数据的方式进行测试难以兼顾整个客户端-服务器通信的过程。综上决定构造客户端模拟器来测试。客户端模拟器如图4-1所示，flow代表一次收发协议的过程，scene代表一次逻辑交互的过程。不同flow的组合构成了scene，不同的scene能测试不同的服务器内部代码块。客户端模拟器复用了服务器中收发协议的模块，同样由java语言编写，还使用了线程池技术，能够同时收发几万条rpc消息。在客户端模拟器中提前组装好完整的scene，通过命令行可以指定模拟器运行的scene、运行的次数、该场景有多少玩家同时在线等参数，启动模拟器并开始对服务器进行压力测试。
 
图4-1模拟器架构图
4.3.2	功能性测试
    一般情况下服务器的开发进度是超过客户端的，但在某些时间节点，客户端会和服务器开发进度同步。此时就需要两边联合调试，在客户端完成真正的界面显示后，由服务器提供看不见的数据服务，并在客户端观察功能是否正常运行。细分到具体实施方案上，对服务器的功能性测试主要通过在客户端进行UI测试和GM工具测试构成。UI测试是指，当客户端处于某一特定状态时，点击被测按钮或者界面后，客户端会根据服务器的回复在界面中做出响应，此时就可以通过客户端的响应判断服务器中对应的功能是否正常运行。但某些状态很难达到，例如连续登录100天或者累计夺冠100次，测试时很难真的处于这些状态，此时需要借助由服务器提供的GM工具强行修改数据，将状态置为特定值，处于特定状态后再进行UI测试。
5．	技术难度及特色分析
5.1技术难点
（1）功能拆分 
原有系统继承于上一个游戏的服务器代码，且上一个游戏的类型和本游戏不符，有许多冗余的功能和属性。这些多余的部分 在某种程度上充当了代码的粘合剂，在开发时为了实现这些部分杂揉了许多功能和模块。同时上一个游戏服务器主要是单体应用，即使在代码目录组织上做了模块拆分，但实际功能上耦合度很高，拆分困难。 
（2）性能优化 
既然使用了新框架进行重构，就应该带来某性能、时延、代码可读性等几个方面的提升，否则使用新框架就没有意义。但不是简单的套用新框架就能带来提升，而是要合理的规划代码功能和解决遗留问题。保质保量的提升代码水平，借助软件工程分析方法对服务进行合理抽象、分解，综合多方面的努力才能实现性能上的提升。
（3）服务上云
在完成代码编写后，如果想将服务部署到云原生平台上，首先使用容器化技术对当前服务所在的运行环境进行打包，推送到镜像仓库后由k8s的控制器拉取镜像，最后将镜像实例化成服务。以上步骤比较复杂，对操作者不友好，所以需要进行封装，保留必要的接口后简化。
5.2特色分析
（1）走在游戏服务器开发方向前沿,将其他方向的先进开发技术和理念带入游戏服务器开发 
（2）使用微服务框架带来性能上的提升
（3）借助云原生平台的特性降低运维成本
6、本人主要工作描述
（1）整理原有技术文档，对功能进行拆分成微服务
（2）重构代码，实现架构的微服务化
（3）编写构建—部署流水线，加速开发效率

 
四、工作进度的大致安排
应包括文献调研，工程设计，项目开发和调试，实验数据的分析处理，撰写论文等。
时间	工作	阶段成果
2021.08 – 2021.09	熟悉项目架构，跑通逻辑流程，学习微服务理念	能够运行现有项目
学习技术文档
2021.09 – 2021.11	尝试拆分原有单体架构，抽象出大厅的活动做为微服务	完成活动微服务代码
2021.11 – 2022.01	完善测试工具模拟器，编写已有微服务模块的测试用例，输出测试文档	完成模拟器代码功能
测试活动微服务的功能
2022.01 – 2022.02 	学习kubernetes原理，将微服务部署到云原生平台	完成流水线构建

2022.01 – 2022.04	进一步抽象出其他微服务	完成更多微服务代码
2022.05 – 2022.07	将现有微服务各模块的功能梳理一遍，输出技术文档，整理不足并改进	输出技术文档
2022.07 – 2022.10	撰写毕业论文，准备毕业答辩	准备毕业事宜


五、预期成果
应包括软硬件产品、文档、模型、专利、论文等
部分微服务化，部署在云原生平台上的游戏服务器

